{"remainingRequest":"C:\\Users\\Ray\\WebstormProjects\\vote_app4\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!C:\\Users\\Ray\\WebstormProjects\\vote_app4\\src\\views\\newImageVote.vue?vue&type=style&index=0&id=57c92f02&scoped=true&lang=css&","dependencies":[{"path":"C:\\Users\\Ray\\WebstormProjects\\vote_app4\\src\\views\\newImageVote.vue","mtime":1577779588822},{"path":"C:\\Users\\Ray\\WebstormProjects\\vote_app4\\node_modules\\css-loader\\dist\\cjs.js","mtime":499162500000},{"path":"C:\\Users\\Ray\\WebstormProjects\\vote_app4\\node_modules\\vue-loader\\lib\\loaders\\stylePostLoader.js","mtime":499162500000},{"path":"C:\\Users\\Ray\\WebstormProjects\\vote_app4\\node_modules\\postcss-loader\\src\\index.js","mtime":499162500000},{"path":"C:\\Users\\Ray\\WebstormProjects\\vote_app4\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"C:\\Users\\Ray\\WebstormProjects\\vote_app4\\node_modules\\vue-loader\\lib\\index.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:CgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKaHIgewogICAgbWFyZ2luLXRvcDogMHB4OwogICAgbWFyZ2luOiAwOwogICAgYm9yZGVyOiAwOwogICAgY29sb3I6ICNlMGUwZTA7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjZTBlMGUwOwogICAgaGVpZ2h0OiAxcHgKfQo="},{"version":3,"sources":["newImageVote.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAsbA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"newImageVote.vue","sourceRoot":"src/views","sourcesContent":["<template>\r\n    <div style=\"margin-bottom: 100px\">\r\n        <van-cell-group>\r\n            <van-field v-model=\"voteTilte\" placeholder=\"投票标题\"/>\r\n            <van-field\r\n                    v-model=\"description\"\r\n                    rows=\"4\"\r\n                    type=\"textarea\"\r\n                    placeholder=\"请输入描述（图片可选）\"\r\n                    show-word-limit\r\n            />\r\n        </van-cell-group>\r\n        <van-uploader v-model=\"descriptionImgList\" :max-count=\"1\" multiple\r\n                      style=\"margin: 8px 8px\"/>\r\n        <hr style=\"height: 7px\">\r\n        <van-cell-group v-for=\"(item,i) in optionList\" :key=\"i\">\r\n            <van-row>\r\n                <van-col span=\"2\">\r\n                    <img src=\"../assets/images/del.png\" style=\"margin:12px 5px;\" height=\"24px\" width=\"24px\"\r\n                         @click=\"delTable(i)\">\r\n                </van-col>\r\n                <van-col span=\"3\">\r\n                    <van-uploader v-model=\"item.img\" preview-size=\"42px\" :max-count=\"1\" multiple\r\n                                  style=\"margin-top: 5px\"/>\r\n                </van-col>\r\n                <van-col span=\"19\">\r\n                    <van-field v-model=\"item.content\" placeholder=\"选项内容\" style=\"margin-top: 5px\"/>\r\n                </van-col>\r\n            </van-row>\r\n        </van-cell-group>\r\n        <van-row>\r\n            <van-col span=\"2\">\r\n                <img src=\"../assets/images/add.png\" style=\"margin:12px 5px;\" height=\"24px\" width=\"24px\"\r\n                     @click=\"addTable()\">\r\n            </van-col>\r\n            <van-col span=\"22\">\r\n                <span style=\"color: #2a89ff;display: block;margin-top: 10px\" @click=\"addTable()\">添加选项</span>\r\n            </van-col>\r\n        </van-row>\r\n        <hr style=\"height: 7px\">\r\n        <van-cell-group>\r\n            <van-field v-model=\"maxVote\" placeholder=\"每人最多可投(默认为1)\" type=\"number\"/>\r\n            <van-row>\r\n                <van-col span=\"21\">\r\n                    <span style=\"display: block;margin: 14px 16px\">自定义分享图（选填）</span>\r\n                </van-col>\r\n                <van-col span=\"3\">\r\n                    <van-uploader v-model=\"shareImg\" preview-size=\"42px\" :max-count=\"1\" multiple\r\n                                  style=\"margin-top: 5px\"/>\r\n                </van-col>\r\n            </van-row>\r\n        </van-cell-group>\r\n        <van-cell-group>\r\n            <van-row>\r\n                <van-col span=\"16\">\r\n                    <span style=\"display: block;margin: 14px 16px\">开始时间</span>\r\n                </van-col>\r\n                <van-col span=\"8\">\r\n                    <span @click=\"onShow1\" style=\"display: block;margin-top: 14px\">{{startTime}}</span>\r\n                </van-col>\r\n            </van-row>\r\n        </van-cell-group>\r\n        <van-cell-group>\r\n            <van-row>\r\n                <van-col span=\"16\">\r\n                    <span style=\"display: block;margin: 14px 16px\">截止时间</span>\r\n                </van-col>\r\n                <van-col span=\"8\">\r\n                    <span @click=\"onShow2\" style=\"display: block;margin-top: 14px\">{{deadline}}</span>\r\n                </van-col>\r\n            </van-row>\r\n        </van-cell-group>\r\n        <van-action-sheet v-model=\"timeShow1\">\r\n            <van-datetime-picker\r\n                    v-model=\"timeSet.currentDate\"\r\n                    type=\"datetime\"\r\n                    :min-date=\"timeSet.minDate\"\r\n                    :max-date=\"timeSet.maxDate\"\r\n                    :formatter=\"formatter\"\r\n                    @confirm=\"confirmTime1\"\r\n                    @cancel=\"cancelTime\"\r\n            />\r\n        </van-action-sheet>\r\n        <van-action-sheet v-model=\"timeShow2\">\r\n            <van-datetime-picker\r\n                    v-model=\"timeSet.currentDate\"\r\n                    type=\"datetime\"\r\n                    :min-date=\"timeSet.minDate\"\r\n                    :max-date=\"timeSet.maxDate\"\r\n                    :formatter=\"formatter\"\r\n                    @confirm=\"confirmTime2\"\r\n                    @cancel=\"cancelTime\"\r\n            />\r\n        </van-action-sheet>\r\n        <div class=\"d-flex justify-content-center\">\r\n            <button type=\"button\" class=\"btn btn-primary\" style=\"margin-top: 20px\" @click=\"createVote\">立即发起投票</button>\r\n        </div>\r\n    </div>\r\n</template>\r\n\r\n<script>\r\n    export default {\r\n        name: \"newImageVote\",\r\n        data() {\r\n            return {\r\n                isLogin: false,\r\n                loginUser: {},\r\n                timeShow1: false,\r\n                timeShow2: false,\r\n                voteTilte: '',\r\n                optionList: [{\r\n                    img: [],\r\n                    content: ''\r\n                }, {\r\n                    img: [],\r\n                    content: ''\r\n                }\r\n                ],\r\n                description: '',\r\n                //简介图片\r\n                descriptionImgList: [],\r\n                //分享图片\r\n                shareImg: [],\r\n                maxVote: '',\r\n                timeSet: {\r\n                    minDate: new Date(),\r\n                    maxDate: new Date(2100, 11, 31),\r\n                    currentDate: new Date()\r\n                },\r\n                startTime: new Date().format(\"yyyy-MM-dd hh:mm\"),\r\n                deadline: '',\r\n                newVote: {},\r\n            }\r\n        },\r\n        methods: {\r\n\r\n            // afterRead(file) {\r\n            //     console.log(file)\r\n            // },\r\n            // test(){\r\n            //     this.$notify({\r\n            //         message: '图片上传失败',\r\n            //         duration: 1000\r\n            //     });\r\n            // },\r\n            createVote: async function () {\r\n                if (this.voteTilte == '') {\r\n                    this.$dialog.alert({\r\n                        message: '请填写标题'\r\n                    }).then(() => {\r\n                        // on close\r\n                    });\r\n                } else if (this.optionList.length == 0) {\r\n                    this.$dialog.alert({\r\n                        message: '请至少添加一个选项'\r\n                    }).then(() => {\r\n                        // on close\r\n                    });\r\n                } else {\r\n                    for (let i in this.optionList) {\r\n                        if (this.optionList[i].img[0] == null) {\r\n                            this.$dialog.alert({\r\n                                message: '请上传选项图片'\r\n                            }).then(() => {\r\n                                // on close\r\n                            });\r\n                            return;\r\n                        } else if (this.optionList[i].content == '') {\r\n                            this.$dialog.alert({\r\n                                message: '请填写标题选项内容'\r\n                            }).then(() => {\r\n                                // on close\r\n                            });\r\n                            return;\r\n                        }\r\n                    }\r\n                    //检查标题唯一性\r\n                    let isExist=await this.checkTitle(this.voteTilte);\r\n                    if (isExist == false) {\r\n                        console.log(\"标题已存在\");\r\n                        this.$dialog.alert({\r\n                            message: '该标题已存在'\r\n                        }).then(() => {\r\n                            // on close\r\n                        });\r\n                        return;\r\n                    }\r\n                    this.$toast.loading({\r\n                        message: '创建中...',\r\n                        forbidClick: true,\r\n                        duration: 0,\r\n                    });\r\n                    let isUpload = true;\r\n                    let isCreateVote = false;\r\n                    let isSaveOption = false;\r\n                    //将最大投票数默认置为1\r\n                    if (this.maxVote == null) {\r\n                        this.maxVote = 1;\r\n                    }\r\n                    let vote = {\r\n                        creator: this.loginUser,\r\n                        title: this.voteTilte,\r\n                        description: this.description,\r\n                        descriptionImg: \"\",\r\n                        shareImg: \"\",\r\n                        startTime: this.startTime,\r\n                        deadline: this.deadline,\r\n                        onceMaxVote: this.maxVote,\r\n                    };\r\n                    //上传图片\r\n                    if (this.descriptionImgList[0] != null) {\r\n                        //同步执行 需等待文件上传完毕\r\n                        vote.descriptionImg = await this.uploadImg(this.descriptionImgList[0]);\r\n                        if (vote.descriptionImg == null) {\r\n                            isUpload = false;\r\n                        }\r\n                    }\r\n                    if (this.shareImg[0] != null) {\r\n                        vote.shareImg = await this.uploadImg(this.shareImg[0]);\r\n                        if (vote.shareImg == null) {\r\n                            isUpload = false;\r\n                        }\r\n                    }\r\n                    // console.log(vote)\r\n                    //保存投票信息\r\n                    isCreateVote=await this.saveVote(vote);\r\n                    //保存选项信息\r\n                    for (let i in this.optionList) {\r\n                        let imgName = await this.uploadImg(this.optionList[i].img[0]);\r\n                        if (imgName == null) {\r\n                            isUpload = false;\r\n                        }\r\n                        isSaveOption=await this.saveOption(imgName,i)\r\n                    }\r\n                    if (isUpload == false) {\r\n                        this.$toast.clear();\r\n                        this.$notify({\r\n                            message: '图片上传失败',\r\n                            duration: 1000\r\n                        });\r\n                    } else if (isCreateVote == false) {\r\n                        this.$toast.clear();\r\n                        this.$notify({\r\n                            message: '投票创建失败',\r\n                            duration: 1000\r\n                        });\r\n                    } else if (isSaveOption == false) {\r\n                        this.$toast.clear();\r\n                        this.$notify({\r\n                            message: '选项保存失败',\r\n                            duration: 1000\r\n                        });\r\n                    } else {\r\n                        this.$toast.clear();\r\n                        window.location.href = '/myVote';\r\n                    }\r\n                }\r\n            },\r\n            checkTitle:async function(tilte){\r\n                let isExist=false;\r\n                let checkUrl = this.website + \"/vote/checkTitle\";\r\n                await this.axios.get(checkUrl, {\r\n                    params: {\r\n                        voteTitle: tilte\r\n                    }\r\n                }).then(function (response) {\r\n                    if (response.data.code == 200) {\r\n                        isExist = response.data.data;\r\n                    } else {\r\n                        console.log(\"检查过程出错\");\r\n                    }\r\n                }).catch(function (err) {\r\n                    // eslint-disable-next-line no-console\r\n                    console.log(err);\r\n                });\r\n                return isExist;\r\n            },\r\n            saveVote:async function(vote){\r\n                let isCreateVote=false;\r\n                let that=this;\r\n                let createVoteUrl = this.website + \"/vote/createVote\";\r\n                await this.axios.post(createVoteUrl, vote).then(function (response) {\r\n                    if (response.data.code == 200) {\r\n                        that.newVote = response.data.data;\r\n                        console.log(\"创建投票成功\");\r\n                        isCreateVote = true;\r\n                    } else {\r\n                        console.log(\"创建失败\");\r\n                    }\r\n                }).catch(function (err) {\r\n                    // eslint-disable-next-line no-console\r\n                    console.log(err);\r\n                });\r\n                return isCreateVote;\r\n            },\r\n            saveOption:async function(imgName,i){\r\n                let isSaveOption=false;\r\n                let saveOptionUrl = this.website + \"/option/saveOption\";\r\n                await this.axios.post(saveOptionUrl, {\r\n                    img: imgName,\r\n                    content: this.optionList[i].content,\r\n                    vote: this.newVote,\r\n                    votes: 0\r\n                }).then(function (response) {\r\n                    if (response.data.code == 200) {\r\n                        console.log(i + \"选项添加成功\");\r\n                        isSaveOption = true;\r\n                    } else {\r\n                        console.log(i + \"选项添加失败\");\r\n                        isSaveOption = false;\r\n                    }\r\n                }).catch(function (err) {\r\n                    // eslint-disable-next-line no-console\r\n                    console.log(err);\r\n                })\r\n                return isSaveOption;\r\n            },\r\n            delTable(idx) {\r\n                this.optionList = this.optionList.filter((\r\n                    item, i) => {\r\n                    // console.log([item, i, idx])\r\n                    if (i != idx) {\r\n                        return \"e\"\r\n                    }\r\n                })\r\n            },\r\n            addTable() {\r\n                this.optionList.push({\r\n                    img: [],\r\n                    content: ''\r\n                })\r\n            },\r\n            onShow1() {\r\n                this.timeShow1 = true\r\n            },\r\n            onShow2() {\r\n                this.timeShow2 = true\r\n            },\r\n            confirmTime1(value) {\r\n                this.startTime = value.format(\"yyyy-MM-dd hh:mm\")\r\n                this.timeShow1 = false\r\n            },\r\n            confirmTime2(value) {\r\n                this.deadline = value.format(\"yyyy-MM-dd hh:mm\")\r\n                this.timeShow2 = false\r\n            },\r\n            cancelTime() {\r\n                this.timeShow1 = false\r\n                this.timeShow2 = false\r\n            },\r\n            formatter(type, value) {\r\n                if (type === 'year') {\r\n                    return `${value}年`;\r\n                } else if (type === 'month') {\r\n                    return `${value}月`\r\n                } else if (type === 'day') {\r\n                    return `${value}日`\r\n                } else if (type === 'hour') {\r\n                    return `${value}时`\r\n                } else if (type === 'minute') {\r\n                    return `${value}分`\r\n                }\r\n                return value;\r\n            },\r\n            uploadImg: async function (imgFile) {\r\n                // let that=this;\r\n                let imgName = imgFile.file.name;\r\n                let config = {\r\n                    headers: { //添加请求头\r\n                        \"Content-Type\": \"multipart/form-data\"\r\n                    }\r\n                };\r\n                let uploadUrl = this.website + \"/commons/upload\";\r\n                let params = new FormData(); //创建form对象\r\n                params.append(\"file\", imgFile.file); //通过append向form对象添加数据//第一个参数字符串可以填任意命名，第二个根据对象属性来找到file\r\n                await this.axios.post(uploadUrl, params, config).then(function (response) {\r\n                    if (response.data.code == 200) {\r\n                        // if(imgFile==that.descriptionImgList[0]){\r\n                        //     that.descriptionImgName=response.data.data;\r\n                        //     // console.log(that.descriptionImgName)\r\n                        // }else if(imgFile==that.shareImg[0]){\r\n                        //     that.shareImgName=response.data.data;\r\n                        //     // console.log(that.shareImgName)\r\n                        // }\r\n                        console.log(imgName + \"图片上传成功\");\r\n                        imgName = response.data.data;\r\n                    } else {\r\n                        console.log(\"上传失败\");\r\n                    }\r\n                }).catch(function (err) {\r\n                    // eslint-disable-next-line no-console\r\n                    console.log(err);\r\n                })\r\n                return imgName;\r\n            }\r\n        },\r\n        mounted() {\r\n            let date = new Date();\r\n            date.setDate(date.getDate() + 7)\r\n            this.deadline = date.format(\"yyyy-MM-dd hh:mm\")\r\n            if (sessionStorage.getItem(\"loginUser\") != null || localStorage.getItem(\"loginUser\") != null) {\r\n                this.isLogin = true;\r\n                if (sessionStorage.getItem(\"loginUser\") != null) {\r\n                    this.loginUser = JSON.parse(sessionStorage.getItem(\"loginUser\"));\r\n                }\r\n                if (localStorage.getItem(\"loginUser\") != null) {\r\n                    this.loginUser = JSON.parse(localStorage.getItem(\"loginUser\"));\r\n                }\r\n            }\r\n        }\r\n    }\r\n    Date.prototype.format = function (fmt) {\r\n        var o = {\r\n            \"M+\": this.getMonth() + 1,                 //月份\r\n            \"d+\": this.getDate(),                    //日\r\n            \"h+\": this.getHours(),                   //小时\r\n            \"m+\": this.getMinutes(),                 //分\r\n            \"s+\": this.getSeconds(),                 //秒\r\n            \"q+\": Math.floor((this.getMonth() + 3) / 3), //季度\r\n            \"S\": this.getMilliseconds()             //毫秒\r\n        };\r\n\r\n        if (/(y+)/.test(fmt)) {\r\n            fmt = fmt.replace(RegExp.$1, (this.getFullYear() + \"\").substr(4 - RegExp.$1.length));\r\n        }\r\n\r\n        for (var k in o) {\r\n            if (new RegExp(\"(\" + k + \")\").test(fmt)) {\r\n                fmt = fmt.replace(\r\n                    RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : ((\"00\" + o[k]).substr((\"\" + o[k]).length)));\r\n            }\r\n        }\r\n        return fmt;\r\n    }\r\n\r\n</script>\r\n\r\n<style scoped>\r\n    hr {\r\n        margin-top: 0px;\r\n        margin: 0;\r\n        border: 0;\r\n        color: #e0e0e0;\r\n        background-color: #e0e0e0;\r\n        height: 1px\r\n    }\r\n</style>"]}]}